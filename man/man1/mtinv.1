.TH mtinv 1 "27 April 2023" "MTINV Version 4.0.1" "MTINV Toolkit"

.SH NAME 
mtinv \- deviatoric and full moment tensor inversion or forward calculation(dc only)

.SH SYNOPSIS
mtinv
par=(string)
mtdegfree=(float)
ts0=(float)
[no]fwd
[no]verbose
[no]gmtmap
[no]dumpsac
[no]PltXcorLabel
no]gmt5 
[no]compute_station_vred
[no]AutoAuth
evid=(long)
fixz=(float)
FixISOZ=(float)
{
[no]norm
R0=(float) 
}
{
[no]shift
ctol=(float)
maxshift=(float)
}
{
[no]use_snr
minsnr=3
}
{
[no]dumpxy
orientation=(string)
sort_by_value=(string)
[no]print_gmtwf_mt_info
}
{
[no]mysql
[no]oracle
[no]sqlite
[no]sqlite3
[no]special
}
.sp
basic deviatoric MT:
.br
 mtinv par=mtinv.par mtdegfree=5 ts0=0 gmt5 use_snr minsnr=3 
  shift ctol=0.85 maxshift=10
.sp
basic full MT:
.br
 mtinv par=mtinv.par mtdegfree=6 ts0=0 gmt5 use_snr minsnr=3
  shift ctol=0.85 maxshift=10
.sp


.SH DESCRIPTION
mtinv reads the same input file used by glib2inv and sacdata2inv to generate processed and filtered
data and Green's function input files and performs an inversion for the 5 or 6 moment tensor elements in a least squares
sense (by Singular Value Decomposition).  The response or fitness of percent double couple and
variance reduction are checked for each source depth and an ASCII formatted E-mail file is generated with the best fit.  A 
postscript plot is also generated with the waveform fit.  Typically sacdata2inv and mtinv can be run inside a C-shell
script looped over origin time values to estimate the optimal origin time and centroid depth.  

.SH REQUIRED PARAMETERS

.TP
.B par=(string) usually named mtinv.par
The file name of the parameter file shared between glib2inv, sacdata2inv, mtinv, and mteig. 
See details and format of this file below (PARAMETER FILE FORMAT). A template par file is autogenerated by makepar. 

.TP
.B mtdegfree=(integer) allowed 1, 5,or 6
The number of degrees of freedom for the moment tensor.  If mtdegfree=5 then Mzz=-(Mxx+Myy) and the 
trace of (Mij) is assume zero.  The isotropic component is also assume zero.  When mtdegfree=1 the moment tensor
solution is constrained to be only M0=(Mxx+Myy+Mzz)/3 while the off diagonal elements are Mxy=Mxz=Myz=0.  When
mtdegfree=6 the solution includes all 6 unqiue elements of the tensor. 

.TP
.B ts0=(float)
The number of seconds to shift all of the data relative to the origin time.  The data are shifted within mtinv
and not windowed again by sacdata2inv saving time. Recommend resetting OT afterwards so ts0=0 is best fit.
See mtinv.par OT line for absolute origin-time.

.SH OPTIONAL PARAMETERS

.TP
.B [no]fwd
(boolean) Do only forward calculation using Str/Dip/Rak, Mw, and depth input from mtinv.par. 
Use the EV line in the mtinv.par parameter file for a forward cacluation of the pure double couple focal mechanism
and moment.  All the plots and output files are made as in the inversion.   Default is inversion mode.  Forward
calculation is off.

.TP
.B [no]verbose
(boolean) Give verbose print to stdout. Default is off.

.TP
.B [no]gmtmap
(boolean) Make a GMT C-shell script to plot a map of stations and MT solution. Default is off.
mtinv needs to be run with the current best origin time shift that results with the best fitting depth.
Topography can be shown in the map by setting some C-shell environment variables:
.sp
setenv MTINV_GMT_GRID_FILE /my dir/topography.grid
.br
setenv MTINV_GMT_INT_FILE /my dir/topography.shade
.br
setenv MTINV_GMT_CPT_FILE /my dir/togography.colorpal
.br

.TP
.B [no]dumpsac
(boolean)
Write out data and synthetics as SAC files. default is off

.TP
.B [no]PltXcorLabel
(boolean)
label lag times and cross correlations in the PostScript plot for each chan [Default is on]

.TP
.B [no]gmt5 
(boolean)
Make C-shell scripts compatible with GMT 5+ and GMT 6+ for plotting [default
on]. Otherwise the scripts will be in GMT4+ format.  WARNING! as of MTINV version 4,
gmt4 is no longer support but will remain in the code base.

.TP
.B [no]compute_station_vred
(boolean)
computes variance reductions for each station and channel.  Outputs file var_red.out [default on] 

.TP
.B [no]AutoAuth 
(boolean) use AutoMT as Database output author else uses Operating System Enviroment username default off

.TP
.B evid=(long)
EventID limited to 10 digit long int, default -1 none

.TP
.B fixz=(float)
Do an inversion or forward calculation with fixed depth in km. Program checks for valid depth in Green's function library *.glib file.
[Default off]

.TP
.B FixISOZ=(float)
Fix the depth kilometers of just the isotropic Green's function components (rex and zex). Default is off
Fix the depth of the isotropic Green's functions to the depth specified depth.  This feature allows the assumption
that isotropic sources are always at the surface.  The program will check to see that it is valid.  Otherwise
rerun mkgrnlib to include the depth.

.TP
.B [no]norm  
(boolean) Distance normalization. Normalizes the data and synthetics.  Default is off.

.TP
.B R0=(float)
If norm true then normalize Green functions to distance in km of R/R0 required if norm is set, default 1 km.

.TP
.B [no]shift  
(boolean) Shift the data by the maximum of the cross correlation between data and synthetics computed from the best fitting MT solution.
The variance reduction or data and synthetic fits are not altered. The lag-times need to be entered manually into ts0 column in mtinv.par.
Default is off.

.TP
.B ctol=(float) range is 0 to 1.
When the shift option is on, this is the minimum cross-correlation coefficient allowed to calculate a lag-time between data and synthetics.
If the cross-correlation coefficient is
larger than ctol then the data is shifted to the lag time for this maximum correlation.  Default off.

.TP
.B maxshift=(float)
Maximum time in seconds a shift is allowed. If lag-time at max cross-correlation coefficient is larger than maxshift, then 
the labels are returned returned but not reported.  

.TP
.B [no]use_snr
(boolean) use peak-to-peak amplitude based Signal-Noise Ratio to make stations non-defining in inversion [default off]
If on, then see output file snr.out for channel snr values.

.TP
.B minsnr=(float)
The minimum snr threshold. All 3-components must be less than minsnr to set non-defining in inversion. 
The parameters use_snr and minsnr only applies to stations that are defining and does not override users settings.
There is basic logic to account for radiation pattern of Love and Rayleigh waves.  [default 3]

.TP
.B [no]dumpxy
(boolean) write out (x,y) ascii text files for the data and synthetics for GMT plots [Default is off]
includes GMT C-shell script (gmtwf.csh) which generates pages of postscripts plots - use mtbestfit pretty_plot

.TP
.B orientation=(string) ("portrait" or "landscape") 
if dumpxy on then plot orientation ("portrait" or "landscape") default landscape (default landscape)

.TP
.B sort_by_value=(string) ("dist", "none", "azi", "baz")
if dumpxy on then sorts plot order of waveforms in gmtwf.csh sort_by_value (dist, none, azi, baz) [default dist]

.TP
.B [no]print_gmtwf_mt_info
(boolean) if dumpxy on then print_gmtwf_mt_info controls amount of information about mt solution in gmtwf.csh plot
(default off) Prints: 
.br
max peak amplitude values, frequency bands, depth, Mw, percent iso, dc, clvd, %VR, MT elements 

.TP
.B [no]mysql
(boolean) write out mysql source scripts (create.sql,insert.sql) based on the NNSA custom schema [Default is off]

.TP
.B [no]oracle
(boolean) write out oracle scripts (create.sql,insert.sql) based on the NNSA custom schema [Default is off]

.TP
.B [no]sqlite or [no]sqlite3
(boolean) write out sqlite scripts (create.sql,insert.sql) based on the NNSA custom schema [Default is off]

.TP
.B [no]special 
(boolean) reads Greens function from SAC files in Mij(Z,R,T) format (17 files) not 
RSS,RDS,RDD,REP,ZSS,ZDS... format (10 fundamental faulting orientations) [default off] see grn2Mxy and glib2inv test_special

.SH PARAMETER FILE FORMAT

.B same format as par file for GLIB2INV(1), SACDATA2INV(1), MAKEPAR(1), MTEIG(1)

.TP
.B #
A '#' in the first column signifies that the following is a non printing comment
                                                                                                                  
.TP
.B CM
A 'CM ' in columns 1-3 marks the beginning of a comment, typically the region, area, city and country name
for reference purposes only.
                                                                                                                  
.TP
.B OT
A 'OT ' in columns 1-3 is followed by the earthquake origin time string in year/month/day,hour:minute:seconds format, (e.g.,
2005/06/12,15:41:46.000 or 2005-06-12T15:41:46.000 ).  Origin time is required for aligning the 
synthetics and observed seismograms in time to improve the fit the synthetics and percent isotropic and double couple component.
Depth trades-off with origin-time, therefore we loop over origin-time shift and perform a MT inversion at each iteration to find the best fit.

.TP
.B  EV
A 'EV ' in columns 1-3 is followed by six free formatted floating point values:  strike, dip, rake, Mw, event_longitude, event_latitude, and event_depth.  event_longitude, event_latitude do not matter and is a future feature to do grid searches over epicenter location.  
event_depth must be a valid source depth in Green's function library.  Program will check and quit if not. Just rerun mkgrnlib to add needed depth. 

.TP
All other lines are for station and synthetic data processing parameters.  There are 18 columns in the following order:
.sp
.B sta, net, loc, model, np, pas, lf, hf, nt, dt, tr, tt, grdmo(v/d), mulfac, used(Y/N), ts, wt, wvtype, comment

.B 1 sta=
station code (see stadb file).
                                                                                                                  
.B 2 net=
network code (see stadb file).
 
.B 3 loc=
location code
                                                                                                                 
.B 4 model=
velocity model name (without .mod extension)
                                                                                                                  
.B 5 np=
number of poles (0,1,2,3,4,5,...) for Butterworth bandpass filter
                                                                                                                  
.B 6 pas=
number of passes (1 or 2) for Butterworth bandpass filter
                                                                                                                  
.B 7 lf=
low frequency corner in Hz for Butterworth bandpass filter
                                                                                                                  
.B 8 hf=
high frequency corner in Hz for Butterworth bandpass filter
                                                                                                                  
.B 9 nt=
number of points (in power of 2)
                                                                                                                  
.B 10 dt=
sampling rate in sec/sample
                                                                                                                  
.B 11 tr=
rise time or duration of ramp in trapezoid function in seconds
                                                                                                                  
.B 12 tt=
duration of boxcar portion of trapezoid function in seconds (tt=0 then triangle function of duration 2*tr)
 
.B 13 grdmo=
Ground motion type is either 'd' for displacement or 'v' for velocity (no default)
                                                                                                                                        
.B 14 mulfac=
Multiplcation factor applied to all components for this station. Useful for applying gain corrections easily.
Default is 1.
                                                                                                                                        
.B 15 used=
Use this station for inversion 'y' or just make a preduction 'n'
                                                                                                                                        
.B 16 ts=
Time shift for all components in seconds.  Negative is backward time shift in time and positive shifts are forward shift in time.
Default is 0;
                                                                                                                                        
.B 17 wt=
weight for the data and GFs in the MT inversion A-matrix 

.B 18 wvtyp=
Wave Type = "Surf/Pnl" or "Rotational"

.B 19 comment 
Remark, usually auto computed epicenter distance in km and azimuth degrees

.SH EXAMPLE PARAMETER FILE mtinv.par 
.br
#### REGION COMMENT ############################
.br
CM New Madrid, MO
.br
#### Date and Origin Time ######################
.br
OT 2021-11-18T02:53:04.00
.br
#### Forward Calculations ######################
.br
##    stk    dip    rak   Mw  evlo  evla   Z ##########
.br
EV -999.0 -999.0 -999.0  0.0    -90.543    36.9077  15.0
.br
##########################################################################################
.br
# sta net loc model  np pas lf  hf  nt  dt   tr  tt v/d  mulfac used(Y/N)  ts  weight ###
.br
CGM3 NM 00 cus 3 2 0.075 0.15 1024  0.05 0.0 0.0 d  1.0 y +0.0 +1.0 Surf/Pnl # R=89 Az=61
.br
PENM NM 00 cus 3 2 0.075 0.15 1024  0.05 0.0 0.0 d  1.0 y +0.0 +1.0 Surf/Pnl # R=96 Az=122
.br
HENM NM 00 cus 3 2 0.075 0.15 1024  0.05 0.0 0.0 d  1.0 y +0.0 +1.0 Surf/Pnl # R=97 Az=102
.br
GNAR NM 00 cus 3 2 0.075 0.15 1024  0.05 0.0 0.0 d  1.0 y +0.0 +1.0 Surf/Pnl # R=114 Az=156
.br
CCM  IU 00 cus 3 2 0.075 0.15 1024  0.07 0.0 0.0 d  1.0 y +0.0 +1.0 Surf/Pnl # R=141 Az=334
.br
CCM  IU 10 cus 3 2 0.075 0.15 1024  0.07 0.0 0.0 d  1.0 y +0.0 +1.0 Surf/Pnl # R=141 Az=334
.br
SIUC NM 00 cus 3 2 0.075 0.15 1024  0.07 0.0 0.0 d  1.0 y +0.0 +1.0 Surf/Pnl # R=147 Az=52
.br
SLM  NM 00 cus 3 2 0.075 0.15 1024  0.08 0.0 0.0 d  1.0 y +0.0 +1.0 Surf/Pnl # R=193 Az=8
.br
########################################################################################
.br
#WVT IU 00 cus 3 2 0.075 0.15 1024  0.11 0.0 0.0 d  1.0 n +0.0 +1.0 Surf/Pnl # R=257 Az=109
.br
#WVT IU 10 cus 3 2 0.075 0.15 1024  0.11 0.0 0.0 d  1.0 n +0.0 +1.0 Surf/Pnl # R=257 Az=109
.br


.SH EXAMPLE C-SHELL SCRIPT run.csh
.br
#!/bin/csh
.br
set DEGFREE=6  # 1-isotropic_mt 5-deviatoric_mt 6-full_mt
.sp
cat >! mtinv.par << EOF
.br
see above
.br
EOF
.sp
### PROCESS GREENS FUNCTIONS ###
.br
glib2inv par=mtinv.par noverbose parallel
.sp
### PROCESS DATA ###
.br
sacdata2inv par=mtinv.par path=../Data respdir=../Resp noverbose nodumpsac parallel
.sp
foreach ts0 ( -8 -7 -6 -5 -4 -3 -2 -1 0 1 2 3 4 5 6 7 8 )
.br
 mtinv AutoAuth ts0=${ts0} par=mtinv.par gmt5 mtdegfree=${DEGFREE} use_snr minsnr=3 shift ctol=0.85 maxshift=10 >> mtinv.out
.br
end ### loop over ts0
.sp
### CHECK ORIGIN TIME SHIFT ###
.br
csh results.${DEGFREE}.csh
.sp
### MAKE DEPTH SENSITIVITY PLOT ###
.br
csh plotz.csh
.sp
### MAKE DEPTH / OT-SHIFT SENSITIVITY PLOT ###
.br
csh plotmech.csh
.sp
mtbestfit gmt5 evid=-1 db pretty_plot noforce_best_vred mteig decimate_factor=2
.sp
end of run.csh

.SH "SEE ALSO"
.IR mkgrnlib (1),
.IR glib2inv (1),
.IR sacdata2inv (1),
.IR grnlib2sac (1)
